<head>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://api.trello.com/1/client.js?key=83fbbffdca68e9e5655f409d9b204618"></script>
<!--  python -m http.server -->
</head>
<body>
<script>

counter = 0; // TODO: no global state please
Object.values = obj => Object.keys(obj).map(key => obj[key]);

var extractTags = function(string){
	ret = string.split("--");
	ret = ret.map(function(s){return s.trim();});
	return ret;
};

globalWarning = "";
globalError = "";
asserts = {};
asserts["Check Done and Today"] = function(lists){
	requiredLists = ["Done", "Today", "Inbox"]
	requiredWorkList = ["Today", "Inbox"]
	console.log("check we have Done and Today");
	listNames = Object.values(lists).map(function(i){return i.name;});
	listTags = listNames.map(function(i){return extractTags(i);});
	for( r in requiredLists ){
		rl = requiredLists[r];
		var found = false;
		for( l in listTags ){
			lt = listTags[l];
			if(lt.indexOf(rl) >= 0){
				found = true;
				break;
			}
		}
		if(! found){
			globalError = "List \"" + rl + "\" must exist! I'm not smart enough to create that for you yet :(<br/>"
			return false;
		}
	}
	for( r in requiredWorkList ){
		rl = requiredWorkList[r];
		var found = false;
		for( l in listTags ){
			lt = listTags[l];
			if(lt.indexOf(rl) >= 0 && lt.indexOf("Work") >= 0){
				found = true;
				break;
			}
		}
		if(! found){
			globalError = "List \"" + rl + " -- Work\" must exist! I'm not smart enough to create that for you yet :(<br/>"
			return false;
		}
	}
	console.log("passed!");
	return true;
}
asserts["check Today has associated time, transform to pomodoro ticks"] = function(){
	console.log("check Today has associated time, transform to pomodoro ticks");
	listNames = Object.values(lists).map(function(i){return i.name;});
	listTags = listNames.map(function(i){return extractTags(i);});
	console.log("passed!");
	return true;
}
asserts["check and add tags for time"] = function(){
	console.log("check and add tags for time");
	return true;
}
asserts["check today is sane @time"] = function(){
	console.log("check today is sane @time");
	return true;
}
asserts["check today for date. want everything that is in today to be moved to today, or to be moved to inbox?"] = function(){
	console.log("check today for date. want everything that is in today to be moved to today, or to be moved to inbox?");
	return true;
}
asserts["estimate success of today ending. Stop if under 30%"] = function(){
	console.log("estimate success of today ending. Stop if under 30%");
	return true;
}
asserts["Check today. Check number of items with a warning if they exceed 6. Error out if they exceed 10. Check dates of items. Error out and offer fix with place or fix with move if they're not for today. Compute time left and estimate success. Error out If under 30%"] = function(){
	console.log("Check today. Check number of items with a warning if they exceed 6. Error out if they exceed 10. Check dates of items. Error out and offer fix with place or fix with move if they're not for today. Compute time left and estimate success. Error out If under 30%");
	return true;
}

var done = function(lists){
	document.getElementById("p1").innerHTML = "";
	counter = counter + 1;
	if(counter >= Object.keys(lists).length ){
		for(a in asserts){
			assert = asserts[a];
			if(! assert(lists)){
				document.getElementById("p1").innerHTML = globalError;
				return;
			} else {
				document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML + globalWarning;
				globalWarning = "";
			}
		}
	}
}

var populateLists = function(lists){
	var success = function(answer) {
		cards = {};
		for(i in answer){
			card = answer[i];
			cards[card.id] = card;
		}
		lists[listID].cards = cards;
		done(lists);
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	for(listID in lists){
		Trello.get('/lists/'+ listID +'/cards', success, error);
	}
}

var boardSelect = function(boardID){
	var success = function(answer) {
		document.getElementById("p1").innerHTML = "";
		var lists = {};
		for(i in answer){
			list = answer[i];
			lists[list.id] = list;
		}
		populateLists(lists);
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	Trello.get('/boards/'+ boardID +'/lists', success, error);
}

var authenticationSuccess = function() { 
	console.log("Successful authentication");
	var success = function(boards) {
		document.getElementById("p1").innerHTML = "";
		for( i in boards){
			item = boards[i];
			document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML +
			"<button onclick=\"boardSelect('"+item.id+"')\">" + 
			item.name + "</button><br/>";
		}
	};

	var error = function(errorMsg) {
		console.log(errorMsg);
	};

	Trello.get('/member/me/boards', success, error)
};
var authenticationFailure = function() { alert("Failed authentication"); };

Trello.authorize({
  type: 'popup',
  name: 'Getting Started Application',
  scope: {
    read: 'true',
    write: 'true' },
  expiration: 'never',
  success: authenticationSuccess,
  error: authenticationFailure
});
</script>
<p id="p1">Hello World!</p>
</body>

