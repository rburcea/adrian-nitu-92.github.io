<head>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://api.trello.com/1/client.js?key=83fbbffdca68e9e5655f409d9b204618"></script>
<!--  python -m http.server -->
</head>
<body>
<script>

counter = 0; // TODO: no global state please
globalWarning = "";
globalError = "";
asserts = {};
board = undefined;
Object.values = obj => Object.keys(obj).map(key => obj[key]);

function extractTags(string){
	ret = string.split("--");
	ret = ret.map(function(s){return s.trim();});
	return ret;
};

function swap(obj){
  var ret = {};
  for(var key in obj){
    ret[obj[key].name] = obj[key];
  }
  return ret;
}

function getAnnotedTags(lists){
	listNames = swap(lists);
	listTags = {};
	listTags = Object.keys(listNames).map(function(i){return {tags:extractTags(i),backLink:listNames[i]};});
	return listTags;
}

asserts["Check lists with no time req"] = function(lists){
	console.log("Check lists with no time req");
	var requiredLists = ["Done", "Inbox"]
	listTags = getAnnotedTags(lists);
	for( r in requiredLists ){
		rl = requiredLists[r];
		var found = false;
		for( l in listTags ){
			var lt = listTags[l].tags;
			if(lt.indexOf(rl) >= 0){
				found = true;
				break;
			}
		}
		if(! found){
			globalError = "List \"" + rl + "\" must exist! I'm not smart enough to create that for you yet :(<br/>"
			return false;
		}
	}
	console.log("passed!");
	return true;
}
function genLists(){
	timings = {};
	dayLenghtInMs = (1000 * 60 * 60 * 24);
	weekLengthInMs = (dayLenghtInMs * 7);
	requiredLists = ["Today", "Tomorrow", "Week","Next Work Week", "Month", "3 Month", "6 Month", "Year", "3 Year"];
	prevMoment = {"Today":"Today", "Tomorrow":"Today", "Week":"Tomorrow","Next Work Week":"Today", "Month":"Week", "3 Month":"Month", "6 Month":"3 Month", "Year":"6 Month", "3 Year":"Year"};
	now = new Date().getTime();
	now = now + 4*60*60*1000; // make the day start at 10 PM, yesterday. We need two extra hours for the timezone setting
	todayStart = now - now % dayLenghtInMs;
	yesterStart = todayStart - dayLenghtInMs;
	tomorrowStart = todayStart + dayLenghtInMs;
	tomorrowEnd = tomorrowStart + dayLenghtInMs;
	weekEnd = todayStart + 8 * dayLenghtInMs;
	monthEnd = todayStart + 31 * dayLenghtInMs;
	_3monthEnd = todayStart + 3 * 31 * dayLenghtInMs;
	_6monthEnd = todayStart + 6 * 31 * dayLenghtInMs;
	yearEnd = todayStart + 12 * 31 * dayLenghtInMs;
	_3yearEnd = todayStart + 3 * 12 * 31 * dayLenghtInMs;

	timings["Today"] = {"start":yesterStart, "end":tomorrowStart};
	timings["Tomorrow"] = {"start":tomorrowStart, "end":tomorrowEnd};
	timings["Week"] = {"start":tomorrowEnd, "end":weekEnd};
	timings["Next Work Week"] = {"start":0, "end":monthEnd};
	timings["Month"] = {"start":weekEnd, "end":monthEnd};
	timings["3 Month"] = {"start":monthEnd, "end":_3monthEnd};
	timings["6 Month"] = {"start":_3monthEnd, "end":_6monthEnd};
	timings["Year"] = {"start":_6monthEnd, "end":yearEnd};
	timings["3 Year"] = {"start":yearEnd, "end":_3yearEnd};
}
asserts["Check lists with time req and enrich lists with pomodoro ticks"] = function(lists){
	// breaking "do one thing" policy
	console.log("Check lists with no time req and enrich lists with pomodoro ticks");
	genLists();
	listTags = getAnnotedTags(lists);
	for(l in listTags){
		var found = 0;
		lt = listTags[l].tags;
		for(t in lt){
			tag = lt[t];
			number = parseFloat(tag);
			if(number === number && tag == number + "h"){
				found = found + 1;
				// convert to pomodoro ticks
				listTags[l].backLink.ticks = number/0.5;
			}
			if(requiredLists.indexOf(tag) >= 0){
				found = found + 1;
			}
		}
		if(found == 1){
			globalError = "Lists must have a tag that says how long they are allowed to stretch!<br/>" + JSON.stringify(lt);
			return false;
		}
	}
	for(l in listTags){
		lt = listTags[l].tags;
		for(t in lt){
			tag = lt[t];
			if(requiredLists.indexOf(tag) >= 0){
				finalLists[tag] = listTags[l].backLink
			}
		}
	}
	console.log("passed!");
	return true;
}

var newFunc = function(l, start, end, name){
	cards = l.cards;
	for(c in cards){
		card = cards[c];
		due = new Date(card.due).getTime();
		if(due < start){
			if(name == "Today"){
				continue;
			}
			prevListName = prevMoment[name];
			prevList = finalLists[prevListName];
			Trello.put('/cards/' + card.id + "/idList",{"value":prevList.id}, function(v){console.log(v);}, function(v){console.log(v);});

		}
		if(due > end){
			globalWarning = globalWarning + "Card " + card.name + ": " + card.url + " is not dated correctly. It is scheduled for <b>" +name+ "</b>, but it can be completed later.<br/>";
		}
	}
	return true;
}

asserts["check * for date. want everything that is in today to be moved to today, or to be moved to inbox?"] = function(){
	console.log("check * for date. want everything that is in today to be moved to today, or to be moved to inbox?");
	for(l in requiredLists){
		name = requiredLists[l];
		if(newFunc(finalLists[name], timings[name].start, timings[name].end, name) === false)
			return false;
	}
	return true;
}

function parseTasks(name, list){
	if(list == undefined){
		return true;
	}
	cards = list.cards;
	sumTicks = 0;
	convert = {"30 minute task" : 1, "Hour task": 2, "2 hour task": 4, "3 hour task":6, "5 hour task":10, "8 hour task":16, "13 hour task":26, "Week":5*16, "Month":4*5*16, "3 Month":3*4*5*16, "6 Month":6*4*5*16, "Year":12*4*5*16, "Habbit":0};
	for(c in cards){
		card = cards[c];
		labels = card.labels;
		found = 0;
		ln = undefined;
		card.tick = 0.5;
		card.size = 0.5;
		for(i in labels){
			label = labels[i];
			ln = label.name;
			if(ln == "MIT"){
				card.size = 99999 +1;
				break;
			}
			tick = convert[label.name];
			if(tick != undefined){
				found = found + 1;
				card.tick = tick;
				card.size = tick;
				if(tick === 0)
					card.size = 99999;
			}
		}
		if(found > 1){
			globalError = "Card " + JSON.stringify(card) + " is not labeled correctly <br/>";
			return false;
		} else {
			sumTicks = sumTicks + card.tick;
		}
	}
	list.load = parseInt(String(100*(sumTicks / list.ticks)));
	if(list.load > 75){
		globalWarning = globalWarning + "Seems you are kinda overbooked for " + name + ".<br/>Please reschedule! Drop at least: " + (sumTicks - 0.75*list.ticks)/2  + " hours <br/>";
	}
	if(list.load > 100){
		globalError = globalWarning + "Seems you are overbooked for " + name + ".<br/>Please reschedule!<br/>Drop at least: " + (sumTicks - list.ticks)/2 + " hours <br/>" ;
		return false;
	}
	globalWarning = globalWarning + name + "'s success rate = <b>" + (100-list.load) + "%</b>.<br/>";
	return true;
}
asserts["sort"] = function(){
	console.log("sort");
	for(l in requiredLists){
		name = requiredLists[l];
		parseTasks(name, finalLists[name]);
	}
	globalWarning = globalError = "";
	for(l in requiredLists){
		name = requiredLists[l];
		console.log(name);
		list = finalLists[name];
		cards = list.cards;
		arrayCards = Object.keys(cards).map(function (key) { return cards[key]; });
		arraySortedByPos = arrayCards.slice(0);
		arraySortedByPos.sort(function(a,b){return a.pos - b.pos;});
		arraySortedBySize = arrayCards.slice(0);
		arraySortedBySize.sort(function(a,b){if(a.size == b.size) return new Date(a.due).getTime() - new Date(b.due).getTime(); return b.size - a.size;});
		if((arraySortedByPos.map(function(el){return el.size;}).toString()) != (arraySortedBySize.map(function(el){return el.size;}).toString())){
			console.log(name + " is not sorted!");
			incrementator = 0;
			var doOver = function(){
				if(incrementator <  arraySortedByPos.length){
					card = arraySortedBySize[incrementator];
					console.log("Sorting");
					console.log(card.name + " " + card.size);
					Trello.put('/cards/' + card.id + "/pos",{"value":"bottom"},
						doOver, function(v){console.log(v);});
					incrementator = incrementator +1;
				}
			}
			doOver();
			return true;
		}
	}
	return true;
}
asserts["Test that today has a MIT task"] = function(){
	console.log("Test that today has a MIT task");
	cards = finalLists["Today"].cards;
	ret = false;
	globalError = "You must have at least one MIT card for today! <br/>";
	for(c in cards){
		card = cards[c];
		labels = card.labels;
		for(i in labels){
			label = labels[i];
			ln = label.name;
			if(ln === "MIT"){
				if(ret){
					globalError = "You must have just ONE MIT card for today! <br/>";
					return false;
				}
				ret = true;
				MITcard = card;
			}
		}
	}
	if(ret)
		Trello.put('/cards/' + MITcard.id + "/pos",{"value":"top"},
							function(v){console.log(v);}, function(v){console.log(v);});
	return ret;
}
asserts["check today is sane @time"] = function(){
	console.log("check today is sane @time");
	Object.assign(finalLists["Week"].cards, finalLists["Today"].cards);
	Object.assign(finalLists["Week"].cards, finalLists["Tomorrow"].cards);
	Object.assign(finalLists["Week"].cards, finalLists["Next Work Week"].cards);
	Object.assign(finalLists["Month"].cards, finalLists["Week"].cards);
	Object.assign(finalLists["3 Month"].cards, finalLists["Month"].cards);
	Object.assign(finalLists["6 Month"].cards, finalLists["3 Month"].cards);
	Object.assign(finalLists["Year"].cards, finalLists["6 Month"].cards);
	Object.assign(finalLists["3 Year"].cards, finalLists["Year"].cards);
	for(l in requiredLists){
		name = requiredLists[l];
		if( parseTasks(name, finalLists[name]) === false ){
			return false;
		}
	}
	return true;
}


var done = function(lists){
	document.getElementById("p1").innerHTML = "";
	counter = counter + 1;
	if(counter >= Object.keys(lists).length ){
		for(a in asserts){
			assert = asserts[a];
			if(! assert(lists)){
				document.getElementById("p1").innerHTML = globalError;
				return;
			} else {
				document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML + globalWarning;
				globalWarning = "";
			}
		}
	}
}
finalLists = {}
var populateLists = function(lists){
	finalLists = {}
	var curry = function(listID){
		return function(answer) {
			cards = {};
			for(i in answer){
				card = answer[i];
				cards[card.id] = card;
			}
			lists[listID]["cards"] = cards;
			done(lists);
		};
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	for(listID in lists){
		Trello.get('/lists/'+ listID +'/cards', curry(listID), error);
	}
}

var boardSelect = function(boardID, boardName){
	board = boardName;
	var success = function(answer) {
		document.getElementById("p1").innerHTML = "";
		var lists = {};
		for(i in answer){
			list = answer[i];
			lists[list.id] = list;
		}
		populateLists(lists);
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	Trello.get('/boards/'+ boardID +'/lists', success, error);
}

var authenticationSuccess = function() {
	console.log("Successful authentication");
	var success = function(boards) {
		document.getElementById("p1").innerHTML = "";
		for( i in boards){
			item = boards[i];
			if(item.name === "Grow"){
				gItemID = item.id;
				gItemName = item.name;
				boardSelect(gItemID, gItemName);
			}
			/*
			document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML +
			"<button onclick=\"boardSelect('"+item.id+"', '"+item.name+"')\">" +
			item.name + "</button><br/>";*/
		}
	};

	var error = function(errorMsg) {
		console.log(errorMsg);
	};

	Trello.get('/member/me/boards', success, error);
};
window.onfocus = function(){
	location.reload();
}
var authenticationFailure = function() { alert("Failed authentication"); };

Trello.authorize({
  type: 'popup',
  name: 'Getting Started Application',
  scope: {
    read: 'true',
    write: 'true' },
  expiration: 'never',
  success: authenticationSuccess,
  error: authenticationFailure
});
</script>
<p id="p1">Hello World!</p>
</body>

