<head>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://api.trello.com/1/client.js?key=83fbbffdca68e9e5655f409d9b204618"></script>
<!--  python -m http.server -->
</head>
<body>
<script>

counter = 0; // TODO: no global state please
globalWarning = "";
globalError = "";
asserts = {};
Object.values = obj => Object.keys(obj).map(key => obj[key]);

function extractTags(string){
	ret = string.split("--");
	ret = ret.map(function(s){return s.trim();});
	return ret;
};

function swap(obj){
  var ret = {};
  for(var key in obj){
    ret[obj[key].name] = obj[key];
  }
  return ret;
}

function getAnnotedTags(lists){
	listNames = swap(lists);
	listTags = {};
	listTags = Object.keys(listNames).map(function(i){return {tags:extractTags(i),backLink:listNames[i]};});
	return listTags;
}

asserts["Check lists with no time req"] = function(lists){
	console.log("Check lists with no time req");
	requiredLists = ["Done", "Inbox"]
	listTags = getAnnotedTags(lists);
	for( r in requiredLists ){
		rl = requiredLists[r];
		var found = false;
		for( l in listTags ){
			lt = listTags[l].tags;
			if(lt.indexOf(rl) >= 0){
				found = true;
				break;
			}
		}
		if(! found){
			globalError = "List \"" + rl + "\" must exist! I'm not smart enough to create that for you yet :(<br/>"
			return false;
		}
	}
	console.log("passed!");
	return true;
}

today = undefined;
tomorrow = undefined;
weekend = undefined;
week = undefined;
month = undefined;
_3month = undefined;
asserts["Check lists with time req and enrich lists with pomodoro ticks"] = function(lists){
	// breaking "do one thing" policy
	console.log("Check lists with no time req and enrich lists with pomodoro ticks");
	requiredLists = ["Today", "Tomorrow", "Weekend", "Week", "Month", "3 Month"]
	listTags = getAnnotedTags(lists);
	for(l in listTags){
		var found = 0;
		lt = listTags[l].tags;
		for(t in lt){
			tag = lt[t];
			number = parseFloat(tag);
			if(number === number && tag == number + "h"){
				found = found + 1;
				// convert to pomodoro ticks
				listTags[l].backLink.ticks = number/0.5;
			} 
			if(requiredLists.indexOf(tag) >= 0){
				found = found + 1;
			}
		}
		if(found == 1){
			globalError = "Lists must have a tag that says how long they are allowed to stretch!<br/>" + JSON.stringify(lt);
			return false;
		}
	}
	for(l in listTags){
		lt = listTags[l].tags;
		for(t in lt){
			tag = lt[t];
			if(tag === "Today"){
				today = listTags[l].backLink;
			}
			if(tag === "Tomorrow"){
				tomorrow = listTags[l].backLink;
			}
			if(tag === "Weekend"){
				weekend = listTags[l].backLink;
				
			}
			if(tag === "Week"){
				week = listTags[l].backLink;
			}
			if(tag === "Month"){
				month = listTags[l].backLink;
			}
			if(tag === "3 Month"){
				_3month = listTags[l].backLink;
			}
		}
	}
	console.log("passed!");
	return true;
}

function parseTasks(name, list){
	if(list == undefined){
		return true;
	}
	cards = list.cards;
	sumTicks = 0;
	convert = {"30 minute task" : 1, "Hour task": 2, "2 hour task": 4, "3 hour task":6, "5 hour task":10, "5 minute task" : 0.5, "8 hour task":16, "13 hour task":26, "Habbit":0};
	for(c in cards){
		card = cards[c];
		labels = card.labels;
		found = 0;
		ln = undefined;
		for(i in labels){
			label = labels[i];
			ln = label.name;
			tick = convert[label.name];
			if(tick != undefined){
				sumTicks = sumTicks + tick;
				found = found + 1;
			}
		}
		if(found != 1){
			globalError = "Card " + JSON.stringify(card) + " is not labeled correctly <br/>"
			return false;
		}
		if(card.due == undefined && ln !== "Habbit"){
			globalError = "Card " + JSON.stringify(card) + " doens't have a due date";
			return false;
		}
		console.log(card.due);
	}
	console.log(sumTicks);
	console.log(sumTicks / list.ticks);
	list.load = parseInt(String(100*(sumTicks / list.ticks)));
	if(list.load > 75){
		globalWarning = globalWarning + "Seems you are kinda overbooked for " + name + ".<br/>Please reschedule! Drop at least: " + (sumTicks - 0.75*list.ticks)  + "<br/>";
	}
	if(list.load > 100){
		globalError = "Seems you are kinda overbooked for " + name + ".<br/>Please reschedule!<br/>Drop at least: " + (sumTicks - list.ticks) ;
		return false;
	}
	globalWarning = globalWarning + name + "'s success rate = " + (100-list.load) + "%.<br/>";
	return true;
}
dayLenghtInMs = (1000 * 60 * 60 * 24);
asserts["check today for date. want everything that is in today to be moved to today, or to be moved to inbox?"] = function(){
	console.log("check today for date. want everything that is in today to be moved to today, or to be moved to inbox?");
	now = new Date().getTime();
	now = now + 3*60*60 *1000;
	todayStart = now - now % dayLenghtInMs;
	todayEnd = todayStart + dayLenghtInMs;
	cards = today.cards;
	for(c in cards){
		card = cards[c];
		due = new Date(card.due).getTime();
		if(!((due >= todayStart && due <= todayEnd) || card.labels[0].name === "Habbit")){
			globalError = "Card " + JSON.stringify(card) + " is not dated correctly. It should be today <br/>"
			return false;
		}
		
	}
	return true;
}
asserts["check tomorrow	for date. want everything that is in tomorrow to be moved to tomorrow, or to be moved to inbox?"] = function(){
	console.log("check tomorrow for date. want everything that is in tomorrow to be moved to tomorrow, or to be moved to inbox?");
	now = new Date().getTime();
	now = now + 3*60*60 *1000;
	todayStart = now - now % dayLenghtInMs;
	tomorrowStart = todayStart + dayLenghtInMs;
	tomorrowEnd = tomorrowStart + dayLenghtInMs;
	mondayStart = todayStart + 3 * dayLenghtInMs;
	mondayEnd = mondayStart + dayLenghtInMs;
	cards = tomorrow.cards;
	for(c in cards){
		card = cards[c];
		due = new Date(card.due).getTime();
		if(!((due >= tomorrowStart && due <= tomorrowEnd) || card.labels[0].name === "Habbit")){
			if(!((due >= mondayStart && due <= mondayEnd) || card.labels[0].name === "Habbit")){
				globalError = "Card " + JSON.stringify(card) + " is not dated correctly. It should be tomorrow	 <br/>"
				return false;
			}
		}
		
	}
	return true;
}
asserts["check week	for date. want everything that is in week to be moved to week, or to be moved to inbox?"] = function(){
	console.log("check week for date. want everything that is in week to be moved to week, or to be moved to inbox?");
	now = new Date().getTime();
	now = now + 3*60*60 *1000;
	todayStart = now - now % dayLenghtInMs;
	tomorrowStart = todayStart + dayLenghtInMs;
	tomorrowEnd = tomorrowStart + dayLenghtInMs;
	weekEnd = todayStart + 8 * dayLenghtInMs;
	cards = week.cards;
	for(c in cards){
		card = cards[c];
		due = new Date(card.due).getTime();
		if(!((due >= tomorrowEnd && due <= weekEnd) || card.labels[0].name === "Habbit")){
			globalError = "Card " + JSON.stringify(card) + " is not dated correctly. It should be this week	 <br/>"
			return false;
		}
		
	}
	return true;
}
asserts["check month for date. want everything that is in week to be moved to month, or to be moved to inbox?"] = function(){
	console.log("check month for date. want everything that is in month to be moved to month, or to be moved to inbox?");
	now = new Date().getTime();
	now = now + 3*60*60 *1000;
	todayStart = now - now % dayLenghtInMs;
	tomorrowStart = todayStart + dayLenghtInMs;
	tomorrowEnd = tomorrowStart + dayLenghtInMs;
	weekEnd = todayStart + 8 * dayLenghtInMs;
	monthEnd = todayStart + 31 * dayLenghtInMs;
	cards = month.cards;
	for(c in cards){
		card = cards[c];
		due = new Date(card.due).getTime();
		if(!((due >= weekEnd && due <= monthEnd) || card.labels[0].name === "Habbit")){
			globalError = "Card " + JSON.stringify(card) + " is not dated correctly. It should be this month <br/>"
			return false;
		}
		
	}
	return true;
}
asserts["check 3month for date. want everything that is in 3 to be moved to month, or to be moved to inbox?"] = function(){
	console.log("check month for date. want everything that is in month to be moved to month, or to be moved to inbox?");
	now = new Date().getTime();
	now = now + 3*60*60 *1000;
	todayStart = now - now % dayLenghtInMs;
	tomorrowStart = todayStart + dayLenghtInMs;
	tomorrowEnd = tomorrowStart + dayLenghtInMs;
	weekEnd = todayStart + 8 * dayLenghtInMs;
	monthEnd = todayStart + 31 * dayLenghtInMs;
	_3monthEnd = todayStart + 3 * 31 * dayLenghtInMs;
	cards = _3month.cards;
	for(c in cards){
		card = cards[c];
		due = new Date(card.due).getTime();
		if(!((due >= monthEnd && due <= _3monthEnd) || card.labels[0].name === "Habbit")){
			globalError = "Card " + JSON.stringify(card) + " is not dated correctly. It should be 3 month <br/>"
			return false;
		}
		
	}
	return true;
}


asserts["check today is sane @time"] = function(lists){
	console.log("check today is sane @time");
	tomorrow.ticks = today.ticks + tomorrow.ticks;
	Object.assign(tomorrow.cards, today.cards);
	week.ticks = tomorrow.ticks + week.ticks;
	Object.assign(week.cards, tomorrow.cards);
	week.ticks = weekend.ticks + week.ticks;
	Object.assign(week.cards, weekend.cards);
	month.ticks = month.ticks + week.ticks;
	Object.assign(month.cards, week.cards);
	_3month.ticks = month.ticks + _3month.ticks;
	Object.assign(_3month.cards, month.cards);
	return parseTasks("Today", today) && parseTasks("Tomorrow", tomorrow) && parseTasks("Weekend", weekend) && parseTasks("Week", week) && parseTasks("Month", month) && parseTasks("3 Month", _3month);;
}
var done = function(lists){
	document.getElementById("p1").innerHTML = "";
	counter = counter + 1;
	if(counter >= Object.keys(lists).length ){
		for(a in asserts){
			assert = asserts[a];
			if(! assert(lists)){
				document.getElementById("p1").innerHTML = globalError;
				return;
			} else {
				document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML + globalWarning;
				globalWarning = "";
			}
		}
	}
}

var populateLists = function(lists){
	var curry = function(listID){
		return function(answer) {
			cards = {};
			for(i in answer){
				card = answer[i];
				cards[card.id] = card;
			}
			lists[listID]["cards"] = cards;
			done(lists);
		};
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	for(listID in lists){
		Trello.get('/lists/'+ listID +'/cards', curry(listID), error);
	}
}

var boardSelect = function(boardID){
	var success = function(answer) {
		console.log(answer);
		document.getElementById("p1").innerHTML = "";
		var lists = {};
		for(i in answer){
			list = answer[i];
			lists[list.id] = list;
		}
		populateLists(lists);
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	Trello.get('/boards/'+ boardID +'/lists', success, error);
}

var authenticationSuccess = function() { 
	console.log("Successful authentication");
	var success = function(boards) {
		console.log(boards);
		document.getElementById("p1").innerHTML = "";
		for( i in boards){
			item = boards[i];
			document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML +
			"<button onclick=\"boardSelect('"+item.id+"')\">" + 
			item.name + "</button><br/>";
		}
	};

	var error = function(errorMsg) {
		console.log(errorMsg);
	};

	Trello.get('/member/me/boards', success, error)
};
var authenticationFailure = function() { alert("Failed authentication"); };

Trello.authorize({
  type: 'popup',
  name: 'Getting Started Application',
  scope: {
    read: 'true',
    write: 'true' },
  expiration: 'never',
  success: authenticationSuccess,
  error: authenticationFailure
});
</script>
<p id="p1">Hello World!</p>
</body>

