<head>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://api.trello.com/1/client.js?key=83fbbffdca68e9e5655f409d9b204618"></script>
<!--  python -m http.server -->
</head>
<body>
<script>

counter = 0; // TODO: no global state please
globalWarning = "";
globalError = "";
asserts = {};
board = undefined;
Object.values = obj => Object.keys(obj).map(key => obj[key]);

function extractTags(string){
	ret = string.split("--");
	ret = ret.map(function(s){return s.trim();});
	return ret;
};

function swap(obj){
  var ret = {};
  for(var key in obj){
    ret[obj[key].name] = obj[key];
  }
  return ret;
}

function getAnnotedTags(lists){
	listNames = swap(lists);
	listTags = {};
	listTags = Object.keys(listNames).map(function(i){return {tags:extractTags(i),backLink:listNames[i]};});
	return listTags;
}

asserts["Check lists with no time req"] = function(lists){
	console.log("Check lists with no time req");
	requiredLists = ["Done", "Inbox"]
	listTags = getAnnotedTags(lists);
	for( r in requiredLists ){
		rl = requiredLists[r];
		var found = false;
		for( l in listTags ){
			lt = listTags[l].tags;
			if(lt.indexOf(rl) >= 0){
				found = true;
				break;
			}
		}
		if(! found){
			globalError = "List \"" + rl + "\" must exist! I'm not smart enough to create that for you yet :(<br/>"
			return false;
		}
	}
	console.log("passed!");
	return true;
}
finalLists = {}
function genLists(){
	requiredLists = [];
	timings = {};
	secTimings = {};
	dayLenghtInMs = (1000 * 60 * 60 * 24);
	weekLengthInMs = (dayLenghtInMs * 7);
	mondayStart = 1476640521739;
	if(board === "Grow"){
		requiredLists = ["Today", "Tomorrow", "Weekend", "Week", "Month", "3 Month", "6 Month"];
		now = new Date().getTime();
		now = now + 3*60*60*1000;
		todayStart = now - now % dayLenghtInMs;
		yesterStart = todayStart - dayLenghtInMs;
		tomorrowStart = todayStart + dayLenghtInMs;
		thisMonday = mondayStart;
		while(thisMonday + dayLenghtInMs < now){
			thisMonday = thisMonday + weekLengthInMs;
		}
		thisTuesday = thisMonday + dayLenghtInMs;
		tomorrowEnd = tomorrowStart + dayLenghtInMs;
		thisTuesdayEnd = thisTuesday + dayLenghtInMs;
		weekEnd = todayStart + 8 * dayLenghtInMs;
		monthEnd = todayStart + 31 * dayLenghtInMs;
		_3monthEnd = todayStart + 3 * 31 * dayLenghtInMs;
		_6monthEnd = todayStart + 6 * 31 * dayLenghtInMs;
		timings["Today"] = {"start":yesterStart, "end":tomorrowStart};
		timings["Tomorrow"] = {"start":tomorrowStart, "end":tomorrowEnd};
		timings["Week"] = {"start":tomorrowEnd, "end":weekEnd};
		timings["Month"] = {"start":weekEnd, "end":monthEnd};
		timings["3 Month"] = {"start":monthEnd, "end":_3monthEnd};
		timings["6 Month"] = {"start":_3monthEnd, "end":_6monthEnd};

		secTimings["Today"] = {"start":thisMonday, "end":thisTuesday};
		secTimings["Tomorrow"] = {"start":thisTuesday, "end":thisTuesdayEnd};
		secTimings["Week"] = {"start":0, "end":0};
		secTimings["Month"] = {"start":0, "end":0};
		secTimings["3 Month"] = {"start":0, "end":0};
		secTimings["6 Month"] = {"start":0, "end":0};
	} else if (board === "Work") {
		requiredLists = requiredLists = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
		now = new Date().getTime();
		now = now + 3*60*60 *1000;
		thisMonday = mondayStart;
		while(thisMonday + dayLenghtInMs < now){
			thisMonday = thisMonday + weekLengthInMs;
		}
		thisTuesday = thisMonday + dayLenghtInMs;
		thisWednesday = thisTuesday + dayLenghtInMs;
		thisThursday = thisWednesday + dayLenghtInMs;
		thisFriday = thisThursday + dayLenghtInMs;
		thisFridayEnd = thisFriday + dayLenghtInMs;

		timings["Monday"] = {"start":thisMonday, "end":thisTuesday};
		timings["Tuesday"] = {"start":thisTuesday, "end":thisWednesday};
		timings["Wednesday"] = {"start":thisWednesday, "end":thisThursday};
		timings["Thursday"] = {"start":thisThursday, "end":thisFriday};
		timings["Friday"] = {"start":thisFriday, "end":thisFridayEnd};

		secTimings["Monday"] = {"start":0, "end":0};
		secTimings["Tuesday"] = {"start":0, "end":0};
		secTimings["Wednesday"] = {"start":0, "end":0};
		secTimings["Thursday"] = {"start":0, "end":0};
		secTimings["Friday"] = {"start":0, "end":0};
	}
}
asserts["Check lists with time req and enrich lists with pomodoro ticks"] = function(lists){
	// breaking "do one thing" policy
	console.log("Check lists with no time req and enrich lists with pomodoro ticks");
	genLists();
	listTags = getAnnotedTags(lists);
	for(l in listTags){
		var found = 0;
		lt = listTags[l].tags;
		for(t in lt){
			tag = lt[t];
			number = parseFloat(tag);
			if(number === number && tag == number + "h"){
				found = found + 1;
				// convert to pomodoro ticks
				listTags[l].backLink.ticks = number/0.5;
			} 
			if(requiredLists.indexOf(tag) >= 0){
				found = found + 1;
			}
		}
		if(found == 1){
			globalError = "Lists must have a tag that says how long they are allowed to stretch!<br/>" + JSON.stringify(lt);
			return false;
		}
	}
	for(l in listTags){
		lt = listTags[l].tags;
		for(t in lt){
			tag = lt[t];
			if(requiredLists.indexOf(tag) >= 0){
				finalLists[tag] = listTags[l].backLink
			}
		}
	}
	console.log("passed!");
	return true;
}

function parseTasks(name, list){
	if(list == undefined){
		return true;
	}
	cards = list.cards;
	sumTicks = 0;
	convert = {"30 minute task" : 1, "Hour task": 2, "2 hour task": 4, "3 hour task":6, "5 hour task":10, "5 minute task" : 0.5, "8 hour task":16, "13 hour task":26, "Day":16, "Week":5*16, "Month":4*5*16, "3 Month":3*4*5*16, "6 Month":6*4*5*16, "Year":12*4*5*16, "Habbit":0};
	for(c in cards){
		card = cards[c];
		labels = card.labels;
		found = 0;
		ln = undefined;
		for(i in labels){
			label = labels[i];
			ln = label.name;
			tick = convert[label.name];
			if(tick != undefined){
				sumTicks = sumTicks + tick;
				found = found + 1;
			}
		}
		if(found != 1){
			globalError = "Card " + JSON.stringify(card) + " is not labeled correctly <br/>"
			return false;
		}
		if(card.due == undefined && ln !== "Habbit"){
			globalError = "Card " + JSON.stringify(card) + " doens't have a due date";
			return false;
		}
	}
	list.load = parseInt(String(100*(sumTicks / list.ticks)));
	if(list.load > 75){
		globalWarning = globalWarning + "Seems you are kinda overbooked for " + name + ".<br/>Please reschedule! Drop at least: " + (sumTicks - 0.75*list.ticks)  + "<br/>";
	}
	if(list.load > 100){
		globalError = "Seems you are kinda overbooked for " + name + ".<br/>Please reschedule!<br/>Drop at least: " + (sumTicks - list.ticks) ;
		return false;
	}
	globalWarning = globalWarning + name + "'s success rate = " + (100-list.load) + "%.<br/>";
	return true;
}
var newFunc = function(l, start, end, name){
	cards = l.cards;
	for(c in cards){
		card = cards[c];
		due = new Date(card.due).getTime();
		if(!((due > start && due < end) || card.labels[0].name === "Habbit")){
			state = due + " < " + start;
			if(due > end){
				state = due + " > " + end;
			}
			globalError = "Card " + JSON.stringify(card) + " is not dated correctly. It should be " +name+ ", but it is " + state + ".<br/>"
			return false;
		}
		
	}
	return true;
}
asserts["check * for date. want everything that is in today to be moved to today, or to be moved to inbox?"] = function(){
	console.log("check * for date. want everything that is in today to be moved to today, or to be moved to inbox?");
	for(l in requiredLists){
		name = requiredLists[l];
		pass = false;
		if(board === "Grow" && name === "Weekend"){
			pass = true;
		}
		if(pass === false)
			if(newFunc(finalLists[name], timings[name].start, timings[name].end, name) === false)
				//if(newFunc(finalLists[name], secTimings[name].start, secTimings[name].end, name) === false)
					return false;
	}
	return true;
}


asserts["check today is sane @time"] = function(){
	console.log("check today is sane @time");
	if(board === "Grow"){
		Object.assign(finalLists["Week"].cards, finalLists["Today"].cards);
		Object.assign(finalLists["Week"].cards, finalLists["Tomorrow"].cards);
		Object.assign(finalLists["Week"].cards, finalLists["Weekend"].cards);
		Object.assign(finalLists["Month"].cards, finalLists["Week"].cards);
		Object.assign(finalLists["3 Month"].cards, finalLists["Month"].cards);
		Object.assign(finalLists["6 Month"].cards, finalLists["3 Month"].cards);
	}
	for(l in requiredLists){
		name = requiredLists[l];
		if( parseTasks(name, finalLists[name]) === false ){
			return false;
		}
	}
	return true;
}
var done = function(lists){
	document.getElementById("p1").innerHTML = "";
	counter = counter + 1;
	if(counter >= Object.keys(lists).length ){
		for(a in asserts){
			assert = asserts[a];
			if(! assert(lists)){
				document.getElementById("p1").innerHTML = globalError;
				return;
			} else {
				document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML + globalWarning;
				globalWarning = "";
			}
		}
	}
}

var populateLists = function(lists){
	var curry = function(listID){
		return function(answer) {
			cards = {};
			for(i in answer){
				card = answer[i];
				cards[card.id] = card;
			}
			lists[listID]["cards"] = cards;
			done(lists);
		};
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	for(listID in lists){
		Trello.get('/lists/'+ listID +'/cards', curry(listID), error);
	}
}

var boardSelect = function(boardID, boardName){
	board = boardName;
	var success = function(answer) {
		document.getElementById("p1").innerHTML = "";
		var lists = {};
		for(i in answer){
			list = answer[i];
			lists[list.id] = list;
		}
		populateLists(lists);
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	Trello.get('/boards/'+ boardID +'/lists', success, error);
}

var authenticationSuccess = function() {
	console.log("Successful authentication");
	var success = function(boards) {
		document.getElementById("p1").innerHTML = "";
		for( i in boards){
			item = boards[i];
			document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML +
			"<button onclick=\"boardSelect('"+item.id+"', '"+item.name+"')\">" +
			item.name + "</button><br/>";
		}
	};

	var error = function(errorMsg) {
		console.log(errorMsg);
	};

	Trello.get('/member/me/boards', success, error);
};
var authenticationFailure = function() { alert("Failed authentication"); };

Trello.authorize({
  type: 'popup',
  name: 'Getting Started Application',
  scope: {
    read: 'true',
    write: 'true' },
  expiration: 'never',
  success: authenticationSuccess,
  error: authenticationFailure
});
</script>
<p id="p1">Hello World!</p>
</body>

