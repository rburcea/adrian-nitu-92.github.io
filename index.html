<head>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://api.trello.com/1/client.js?key=83fbbffdca68e9e5655f409d9b204618"></script>
<!--  python -m http.server -->
</head>
<body>
<script>

counter = 0; // TODO: no global state please
moved = false;
globalWarning = "";
globalError = "";
asserts = {};
board = undefined;

asserts["Check lists with no time req"] = function(lists){
	console.log("Check lists with no time req");
	var requiredLists = ["Done", "Inbox"]
	for( r in requiredLists ){
		rl = requiredLists[r];
		var found = false;
		for( l in lists ){
			var lt = lists[l];
			if(lt.name == rl){
				found = true;
				break;
			}
		}
		if(! found){
			globalError = "List \"" + rl + "\" must exist! I'm not smart enough to create that for you yet :(<br/>"
			return false;
		}
	}
	console.log("passed!");
	return true;
}
var newFunc = function(l, start, end, name){
	cards = l.cards;
	for(c in cards){
		card = cards[c];
		due = new Date(card.due).getTime();
		if(due < start){
			if(name == "Today"){
				continue;
			}
			prevListName = prevMoment[name];
			prevList = lists[prevListName];
			Trello.put('/cards/' + card.id + "/idList",{"value":prevList.id}, function(v){console.log(v);}, function(v){console.log(v);});
			moved = true;

		}
		if(due > end){
			globalWarning = globalWarning + "Card " + card.name + ": " + card.url + " is not dated correctly. It is scheduled for <b>" +name+ "</b>, but it can be completed later.<br/>";
		}
	}
	return true;
}

asserts["check * for date. want everything that is in today to be moved to today, or to be moved to inbox?"] = function(){
	console.log("check * for date. want everything that is in today to be moved to today, or to be moved to inbox?");
	for(l in requiredLists){
		name = requiredLists[l];
		if(newFunc(lists[name], lists[name].start, lists[name].end, name) === false)
			return false;
	}
	return true;
}

function parseTasks(list){
	if(list == undefined){
		return true;
	}
	cards = list.cards;
	sumTicks = 0;
	convert = {"30 minute task" : 0.5, "Hour task": 1, "2 hour task": 2, "3 hour task":3, "5 hour task":5, "8 hour task":8, "13 hour task":13, "Week":5*8, "Month":4*5*8, "3 Month":3*4*5*8, "6 Month":6*4*5*8, "Year":12*4*5*8, "Habbit":0};
	for(c in cards){
		card = cards[c];
		labels = card.labels;
		found = 0;
		ln = undefined;
		card.tick = 0.25;
		card.size = 0.25;
		for(i in labels){
			label = labels[i];
			ln = label.name;
			if(ln == "MIT"){
				card.size = 99999 +1;
				break;
			}
			tick = convert[label.name];
			if(tick != undefined){
				found = found + 1;
				card.tick = tick;
				card.size = tick;
				if(tick === 0)
					card.size = 99999;
			}
		}
		if(found > 1){
			globalError = "Card " + JSON.stringify(card) + " is not labeled correctly <br/>";
			return false;
		} else {
			sumTicks = sumTicks + card.tick;
		}
	}
	list.load = parseInt(String(100*(sumTicks / list.ticks)));
	console.log(name + ":" + sumTicks+"/"+list.ticks);
	if(list.load > 125 || (list.load > 100 && list.name === "Today")){
		globalError = globalWarning + "Seems you are overbooked for " + list.name + ".<br/>Please reschedule!<br/>Drop at least: " + (sumTicks - list.ticks) + " hours <br/>" ;
		return false;
	}
	if(list.load > 100){
		globalWarning = globalWarning + "Seems you are kinda overbooked for <b>" + list.name + "</b>.Please reschedule! Drop at least: <b>" + (sumTicks - list.ticks)  + "</b> hours <br/>";
	} else {
		globalWarning = globalWarning + "<b>" + list.name + "</b>'s success rate = <b>" + (100-list.load) + "%</b>.<br/>";
	}
	return true;
}
asserts["sort"] = function(){
	console.log("sort");
	reqList = ["Inbox"].concat(requiredLists);
	for(l in reqList){
		name = reqList[l];
		parseTasks(lists[name]);
	}
	globalWarning = globalError = "";
	for(l in reqList){
		name = reqList[l];
		console.log(name);
		list = lists[name];
		cards = list.cards;
		arrayCards = Object.keys(cards).map(function (key) { return cards[key]; });
		arraySortedByPos = arrayCards.slice(0);
		arraySortedByPos.sort(function(a,b){return a.pos - b.pos;});
		arraySortedBySize = arrayCards.slice(0);
		arraySortedBySize.sort(function(a,b){if(a.size == b.size) return new Date(a.due).getTime() - new Date(b.due).getTime(); return b.size - a.size;});
		if((arraySortedByPos.map(function(el){return el.size;}).toString()) != (arraySortedBySize.map(function(el){return el.size;}).toString())){
			console.log(name + " is not sorted!");
			incrementator = 0;
			var doOver = function(){
				if(moved){
					// dont sort if at least one card has been moved
					return;
				}
				if(incrementator <  arraySortedByPos.length){
					card = arraySortedBySize[incrementator];
					console.log("Sorting");
					console.log(card.name + " " + card.size);
					Trello.put('/cards/' + card.id + "/pos",{"value":"bottom"},
						doOver, function(v){console.log(v);});
					incrementator = incrementator +1;
				}
			}
			doOver();
			return true;
		}
	}
	return true;
}
asserts["Test that today has a MIT task"] = function(){
	console.log("Test that today has a MIT task");
	cards = lists["Today"].cards;
	ret = false;
	globalError = "You must have at least one MIT card for today! <br/>";
	for(c in cards){
		card = cards[c];
		labels = card.labels;
		for(i in labels){
			label = labels[i];
			ln = label.name;
			if(ln === "MIT"){
				if(ret){
					globalError = "You must have just ONE MIT card for today! <br/>";
					return false;
				}
				ret = true;
				MITcard = card;
			}
		}
	}
	if(ret)
		Trello.put('/cards/' + MITcard.id + "/pos",{"value":"top"},
							function(v){console.log(v);}, function(v){console.log(v);});
	return ret;
}
asserts["check today is sane @time"] = function(){
	console.log("check today is sane @time");
	Object.assign(lists["Week"].cards, lists["Today"].cards);
	Object.assign(lists["Week"].cards, lists["Tomorrow"].cards);
	Object.assign(lists["Week"].cards, lists["Next Work Week"].cards);
	Object.assign(lists["Month"].cards, lists["Week"].cards);
	Object.assign(lists["3 Month"].cards, lists["Month"].cards);
	Object.assign(lists["6 Month"].cards, lists["3 Month"].cards);
	Object.assign(lists["Year"].cards, lists["6 Month"].cards);
	Object.assign(lists["3 Year"].cards, lists["Year"].cards);
	for(l in requiredLists){
		name = requiredLists[l];
		if( parseTasks(lists[name]) === false ){
			return false;
		}
	}
	for(i = 0; i < requiredLists.length - 1; i++){
		name1 = requiredLists[i];
		name2 = requiredLists[i+1];
		if(name1 === "Next Work Week"){
			name1 = "Week";
		}
		if(name2 === "Next Work Week"){
			name2 = "Month";
		}
		obj1 = lists[name1];
		obj2 = lists[name2];
		if(obj2 === undefined){
			break;
		}
		if(obj1.load < obj2.load){
			globalWarning = globalWarning + "Seems there is a hump at <b>" + obj2.name + "</b>. This might mean that you might, at some point, be overloading yourself. Please try to solve some MITs from <b>" + obj2.name + "</b>.<br/>";
		}

	}
	return true;
}


var done = function(){
	document.getElementById("p1").innerHTML = "";
	counter = counter + 1;
	if(counter >= Object.keys(lists).length ){
		for(a in asserts){
			assert = asserts[a];
			if(! assert(lists)){
				document.getElementById("p1").innerHTML = globalError;
				return;
			}
		}
	}
	document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML + globalWarning;
	globalWarning = "";
}
var populateLists = function(){
	var curry = function(listName){
		return function(answer) {
			cards = {};
			for(i in answer){
				card = answer[i];
				cards[card.id] = card;
			}
			lists[listName].cards = cards;
			done();
		};
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	for(listName in lists){
		listID = lists[listName].id;
		Trello.get('/lists/'+ listID +'/cards', curry(listName), error);
	}
}

var boardSelect = function(boardID, boardName){
	board = boardName;
	var success = function(answer) {
		document.getElementById("p1").innerHTML = "";
		for(i in answer){
			list = answer[i];
			list.backlink = list;
			Object.assign(list, lists[list.name]);
			lists[list.name] = list;
		}
		populateLists();
	};

	var error = function(errorMsg) {
	  console.log(errorMsg);
	};

	Trello.get('/boards/'+ boardID +'/lists', success, error);
}

var authenticationSuccess = function() {
	console.log("Successful authentication");
	var success = function(boards) {
		document.getElementById("p1").innerHTML = "";
		for( i in boards){
			item = boards[i];
			if(item.name === "Grow"){
				gItemID = item.id;
				gItemName = item.name;
				boardSelect(gItemID, gItemName);
			}
			/*
			document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML +
			"<button onclick=\"boardSelect('"+item.id+"', '"+item.name+"')\">" +
			item.name + "</button><br/>";*/
		}
	};

	var error = function(errorMsg) {
		console.log(errorMsg);
	};

	Trello.get('/member/me/boards', success, error);
};

var authenticationFailure = function() { alert("Failed authentication"); };

function init(){
	moved = false;
	console.log("v2");
	Trello.authorize({
	  type: 'popup',
	  name: 'Getting Started Application',
	  scope: {
	    read: 'true',
	    write: 'true' },
	  expiration: 'never',
	  success: authenticationSuccess,
	  error: authenticationFailure
	});
	lists = {}
	dayLenghtInMs = (1000 * 60 * 60 * 24);
	weekLengthInMs = (dayLenghtInMs * 7);
	requiredLists = ["Today", "Tomorrow", "Week","Next Work Week", "Month", "3 Month", "6 Month", "Year", "3 Year"];
	prevMoment = {"Today":"Today", "Tomorrow":"Today", "Week":"Tomorrow","Next Work Week":"Today", "Month":"Week", "3 Month":"Month", "6 Month":"3 Month", "Year":"6 Month", "3 Year":"Year"};
	now = new Date().getTime();
	now = now + (2-5)*60*60*1000; // make the day start at 5 AM, today. We need two extra hours for the timezone setting

	todayStart = now - now % dayLenghtInMs;

	currentHour = ((new Date().getTime()) - todayStart + 2*60*60*1000) / (1000 * 60 * 60);
	yesterStart = todayStart - dayLenghtInMs;
	tomorrowStart = todayStart + dayLenghtInMs;
	tomorrowEnd = tomorrowStart + dayLenghtInMs;
	weekEnd = todayStart + 8 * dayLenghtInMs;
	monthEnd = todayStart + 31 * dayLenghtInMs;
	_3monthEnd = todayStart + 3 * 31 * dayLenghtInMs;
	_6monthEnd = todayStart + 6 * 31 * dayLenghtInMs;
	yearEnd = todayStart + 12 * 31 * dayLenghtInMs;
	_3yearEnd = todayStart + 3 * 12 * 31 * dayLenghtInMs;
	console.log(lists);

	baseDay = 12;

	lists["Today"] = {"start":yesterStart, "end":tomorrowStart,"ticks":(29 - currentHour)%24};
	lists["Tomorrow"] = {"start":tomorrowStart, "end":tomorrowEnd,"ticks":baseDay};
	lists["Week"] = {"start":tomorrowEnd, "end":weekEnd,"ticks":baseDay * 8 - baseDay};
	lists["Next Work Week"] = {"start":0, "end":monthEnd,"ticks":32};
	lists["Month"] = {"start":weekEnd, "end":monthEnd,"ticks":lists["Week"].ticks * 4 - lists["Week"].ticks/2};
	lists["3 Month"] = {"start":monthEnd, "end":_3monthEnd,"ticks":lists["Month"].ticks * 3 - lists["Week"].ticks/2};
	lists["6 Month"] = {"start":_3monthEnd, "end":_6monthEnd,"ticks":lists["3 Month"].ticks * 2 - lists["Week"].ticks/2};
	lists["Year"] = {"start":_6monthEnd, "end":yearEnd,"ticks":lists["6 Month"].ticks * 2 - lists["Week"].ticks/2};
	lists["3 Year"] = {"start":yearEnd, "end":_3yearEnd,"ticks":lists["Year"].ticks * 3 - lists["Week"].ticks/2};
}
init();
window.onfocus = init;
</script>
<p id="p1">Hello World!</p>
</body>

